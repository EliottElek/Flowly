
# Self-Hosting Supabase Project with RLS

This guide walks you through the steps to self-host a Supabase project, including creating necessary tables and configuring Row-Level Security (RLS).

---

## Prerequisites

1. **Docker**: Install Docker on your machine. [Get Docker](https://www.docker.com/).
2. **Supabase CLI**: Install the Supabase CLI. [Get Supabase CLI](https://supabase.com/docs/guides/cli).
3. **PostgreSQL Client**: Install a PostgreSQL client for manual database interaction.

---

## Steps to Self-Host

### 1. Initialize a Supabase Project
Run the following command to initialize your Supabase project:
```bash
supabase init
```

### 2. Start Supabase Locally
Start Supabase services:
```bash
supabase start
```

### 3. Connect to the Database
After starting, connect to your PostgreSQL database:
- Host: `localhost`
- Port: `54322` (default for Supabase local setup)
- Username: `postgres`
- Password: `postgres`

Use a PostgreSQL client or command-line tools:
```bash
psql -h localhost -p 54322 -U postgres -d postgres
```

---

## 4. SQL Scripts for Table Creation

Create the required tables using the following SQL scripts.

### Example Schema: Projects, Tasks, Comments

```sql
-- Table: projects
CREATE TABLE public.projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT now()
);

-- Table: tasks
CREATE TABLE public.tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES public.projects (id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT now()
);

-- Table: comments
CREATE TABLE public.comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES public.tasks (id) ON DELETE CASCADE,
    project_id UUID REFERENCES public.projects (id) ON DELETE CASCADE,
    user_id UUID NOT NULL,
    content TEXT NOT NULL,
    parent_id UUID REFERENCES public.comments (id),
    created_at TIMESTAMP DEFAULT now()
);

-- Table: project_members
CREATE TABLE public.project_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES public.projects (id) ON DELETE CASCADE,
    user_id UUID NOT NULL,
    role TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT now()
);
```

---

## 5. SQL Scripts to Add RLS (Row Level Security)

### Enable RLS for Tables
Enable RLS for each table:
```sql
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.project_members ENABLE ROW LEVEL SECURITY;
```

### Policies for `projects`
```sql
CREATE POLICY "Allow access to projects for members" ON public.projects
AS PERMISSIVE FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1
    FROM public.project_members
    WHERE project_members.project_id = projects.id
      AND project_members.user_id = auth.uid()
  )
);
```

### Policies for `tasks`
```sql
CREATE POLICY "Allow access to tasks in accessible projects" ON public.tasks
AS PERMISSIVE FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1
    FROM public.project_members
    WHERE project_members.project_id = tasks.project_id
      AND project_members.user_id = auth.uid()
  )
);
```

### Policies for `comments`
```sql
-- Select: Users can view all comments in accessible tasks
CREATE POLICY "Allow access to comments in accessible projects" ON public.comments
AS PERMISSIVE FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1
    FROM public.project_members
    WHERE project_members.project_id = comments.project_id
      AND project_members.user_id = auth.uid()
  )
);

-- Insert: Users can comment on tasks in accessible projects
CREATE POLICY "Allow commenting on tasks in accessible projects" ON public.comments
AS PERMISSIVE FOR INSERT
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM public.project_members
    WHERE project_members.project_id = comments.project_id
      AND project_members.user_id = auth.uid()
  )
);

-- Update: Users can update their own comments
CREATE POLICY "Allow editing own comments" ON public.comments
AS PERMISSIVE FOR UPDATE
TO authenticated
USING (user_id = auth.uid());

-- Delete: Users can delete their own comments
CREATE POLICY "Allow deleting own comments" ON public.comments
AS PERMISSIVE FOR DELETE
TO authenticated
USING (user_id = auth.uid());
```

---

## 6. Testing Policies

After applying these policies:
1. **Login** as an authenticated user.
2. Use the Supabase query editor or your app to test data access:
   - Ensure users can access only their allowed projects.
   - Test comment editing and deletion.

---

## 7. Deploying the Database

### Export SQL Schema
Once your schema and policies are ready, export them:
```bash
supabase db dump
```

### Apply the Schema to a Remote Database
To deploy the schema to a production database:
1. Copy the SQL dump to the server.
2. Apply it using `psql`:
   ```bash
   psql -h your-db-host -U your-db-user -d your-db-name -f path/to/dump.sql
   ```

---

## 8. Frontend Integration
Ensure your frontend queries align with the RLS rules:
- Use Supabase's client libraries.
- Authenticate users properly (e.g., JWT tokens).

---

## 9. Backup and Maintenance

- Schedule regular backups of your database.
- Test your RLS policies periodically.
