# Supabase default migration

Run this script to initiate the database with the correct schemas. 

```sql
create table "public"."columns" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "name" text,
    "description" text,
    "project_id" uuid,
    "index" bigint
);


alter table "public"."columns" enable row level security;

create table "public"."comments" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "user_id" uuid,
    "task_id" uuid,
    "project_id" uuid,
    "content" jsonb,
    "parent_id" uuid
);


alter table "public"."comments" enable row level security;

create table "public"."organization_members" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "user_id" uuid,
    "org_id" uuid,
    "role" text default 'maintainer'::text
);


create table "public"."organizations" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "name" text,
    "description" text,
    "owner_id" uuid
);


alter table "public"."organizations" enable row level security;

create table "public"."project_members" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "project_id" uuid,
    "user_id" uuid,
    "role" text default 'maintainer'::text
);


create table "public"."projects" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "name" text,
    "description" text,
    "owner_id" uuid default auth.uid(),
    "org_id" uuid
);


alter table "public"."projects" enable row level security;

create table "public"."tags" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "name" text,
    "color" text
);


create table "public"."task_logs" (
    "id" uuid not null default gen_random_uuid(),
    "timestamp" timestamp with time zone default now(),
    "user_id" uuid not null,
    "action" text not null,
    "details" jsonb,
    "task_id" uuid
);


create table "public"."task_tags" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "task_id" uuid,
    "tag_id" uuid
);


create table "public"."tasks" (
    "id" uuid not null default gen_random_uuid(),
    "created_at" timestamp with time zone not null default now(),
    "title" text,
    "description" text,
    "column_id" uuid default gen_random_uuid(),
    "project_id" uuid,
    "priority" text default 'low'::text,
    "content" jsonb,
    "user_id" uuid default auth.uid(),
    "due_on" timestamp with time zone
);


alter table "public"."tasks" enable row level security;

create table "public"."users" (
    "id" uuid not null,
    "user_name" text,
    "email" text,
    "avatar_url" text,
    "first_name" text,
    "last_name" text
);


CREATE UNIQUE INDEX columns_pkey ON public.columns USING btree (id);

CREATE UNIQUE INDEX comments_pkey ON public.comments USING btree (id);

CREATE UNIQUE INDEX organization_members_pkey ON public.organization_members USING btree (id);

CREATE UNIQUE INDEX organizations_pkey ON public.organizations USING btree (id);

CREATE UNIQUE INDEX project_members_pkey ON public.project_members USING btree (id);

CREATE UNIQUE INDEX project_pkey ON public.projects USING btree (id);

CREATE UNIQUE INDEX tags_pkey ON public.tags USING btree (id);

CREATE UNIQUE INDEX task_logs_pkey ON public.task_logs USING btree (id);

CREATE UNIQUE INDEX task_tags_pkey ON public.task_tags USING btree (id);

CREATE UNIQUE INDEX tasks_pkey ON public.tasks USING btree (id);

CREATE UNIQUE INDEX users_pkey ON public.users USING btree (id);

alter table "public"."columns" add constraint "columns_pkey" PRIMARY KEY using index "columns_pkey";

alter table "public"."comments" add constraint "comments_pkey" PRIMARY KEY using index "comments_pkey";

alter table "public"."organization_members" add constraint "organization_members_pkey" PRIMARY KEY using index "organization_members_pkey";

alter table "public"."organizations" add constraint "organizations_pkey" PRIMARY KEY using index "organizations_pkey";

alter table "public"."project_members" add constraint "project_members_pkey" PRIMARY KEY using index "project_members_pkey";

alter table "public"."projects" add constraint "project_pkey" PRIMARY KEY using index "project_pkey";

alter table "public"."tags" add constraint "tags_pkey" PRIMARY KEY using index "tags_pkey";

alter table "public"."task_logs" add constraint "task_logs_pkey" PRIMARY KEY using index "task_logs_pkey";

alter table "public"."task_tags" add constraint "task_tags_pkey" PRIMARY KEY using index "task_tags_pkey";

alter table "public"."tasks" add constraint "tasks_pkey" PRIMARY KEY using index "tasks_pkey";

alter table "public"."users" add constraint "users_pkey" PRIMARY KEY using index "users_pkey";

alter table "public"."columns" add constraint "columns_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."columns" validate constraint "columns_project_id_fkey";

alter table "public"."comments" add constraint "comments_parent_id_fkey" FOREIGN KEY (parent_id) REFERENCES comments(id) not valid;

alter table "public"."comments" validate constraint "comments_parent_id_fkey";

alter table "public"."comments" add constraint "comments_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."comments" validate constraint "comments_project_id_fkey";

alter table "public"."comments" add constraint "comments_task_id_fkey" FOREIGN KEY (task_id) REFERENCES tasks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."comments" validate constraint "comments_task_id_fkey";

alter table "public"."comments" add constraint "comments_user_id_fkey" FOREIGN KEY (user_id) REFERENCES users(id) not valid;

alter table "public"."comments" validate constraint "comments_user_id_fkey";

alter table "public"."organization_members" add constraint "organization_members_org_id_fkey" FOREIGN KEY (org_id) REFERENCES organizations(id) not valid;

alter table "public"."organization_members" validate constraint "organization_members_org_id_fkey";

alter table "public"."organization_members" add constraint "organization_members_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) not valid;

alter table "public"."organization_members" validate constraint "organization_members_user_id_fkey";

alter table "public"."organization_members" add constraint "organization_members_user_id_fkey1" FOREIGN KEY (user_id) REFERENCES users(id) not valid;

alter table "public"."organization_members" validate constraint "organization_members_user_id_fkey1";

alter table "public"."organizations" add constraint "organizations_owner_id_fkey" FOREIGN KEY (owner_id) REFERENCES auth.users(id) not valid;

alter table "public"."organizations" validate constraint "organizations_owner_id_fkey";

alter table "public"."project_members" add constraint "project_members_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."project_members" validate constraint "project_members_project_id_fkey";

alter table "public"."project_members" add constraint "project_members_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) not valid;

alter table "public"."project_members" validate constraint "project_members_user_id_fkey";

alter table "public"."project_members" add constraint "project_members_user_id_fkey1" FOREIGN KEY (user_id) REFERENCES users(id) not valid;

alter table "public"."project_members" validate constraint "project_members_user_id_fkey1";

alter table "public"."projects" add constraint "projects_org_id_fkey" FOREIGN KEY (org_id) REFERENCES organizations(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."projects" validate constraint "projects_org_id_fkey";

alter table "public"."projects" add constraint "projects_owner_id_fkey" FOREIGN KEY (owner_id) REFERENCES auth.users(id) not valid;

alter table "public"."projects" validate constraint "projects_owner_id_fkey";

alter table "public"."task_logs" add constraint "fk_task" FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE not valid;

alter table "public"."task_logs" validate constraint "fk_task";

alter table "public"."task_logs" add constraint "fk_user" FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE not valid;

alter table "public"."task_logs" validate constraint "fk_user";

alter table "public"."task_tags" add constraint "task_tags_tag_id_fkey" FOREIGN KEY (tag_id) REFERENCES tags(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."task_tags" validate constraint "task_tags_tag_id_fkey";

alter table "public"."task_tags" add constraint "task_tags_task_id_fkey" FOREIGN KEY (task_id) REFERENCES tasks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."task_tags" validate constraint "task_tags_task_id_fkey";

alter table "public"."tasks" add constraint "tasks_column_id_fkey" FOREIGN KEY (column_id) REFERENCES columns(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."tasks" validate constraint "tasks_column_id_fkey";

alter table "public"."tasks" add constraint "tasks_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."tasks" validate constraint "tasks_project_id_fkey";

alter table "public"."tasks" add constraint "tasks_user_id_fkey1" FOREIGN KEY (user_id) REFERENCES users(id) not valid;

alter table "public"."tasks" validate constraint "tasks_user_id_fkey1";

alter table "public"."users" add constraint "users_id_fkey" FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE not valid;

alter table "public"."users" validate constraint "users_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.add_organization_member()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Insert into organization_members with the org_id of the project
    INSERT INTO organization_members (user_id, org_id)
    SELECT 
        NEW.user_id, 
        projects.org_id
    FROM projects
    WHERE projects.id = NEW.project_id;

    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.consolidate_logs()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    INSERT INTO task_logs (user_id, action, details, task_id, timestamp)
    SELECT DISTINCT ON (task_id) user_id, action, details, task_id, created_at
    FROM pending_task_logs
    ORDER BY task_id, created_at DESC;

    DELETE FROM pending_task_logs; -- Clear the staging table
END;
$function$
;

CREATE OR REPLACE FUNCTION public.delete_task_tags_relation()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Supprime les relations dans task_tags
    DELETE FROM task_tags
    WHERE task_id = OLD.id OR tag_id = OLD.id;
    RETURN OLD;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_project()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  INSERT INTO project_members (project_id, user_id)
  VALUES (NEW.id, auth.uid()); -- auth.uid() gets the authenticated user's ID.
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$begin
  insert into public.users (id, first_name, last_name, avatar_url, email)
  values (new.id, new.raw_user_meta_data ->> 'first_name', new.raw_user_meta_data ->> 'last_name', new.raw_user_meta_data ->> 'avatar_url', new.raw_user_meta_data ->> 'email');
  return new;
end;$function$
;

CREATE OR REPLACE FUNCTION public.log_significant_task_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF (OLD.title IS DISTINCT FROM NEW.title OR OLD.description IS DISTINCT FROM NEW.description) THEN
        INSERT INTO task_logs (user_id, action, details, task_id)
        VALUES (
            auth.uid(),
            'updated task',
            jsonb_build_object(
                'changed_fields', jsonb_build_object(
                    'title', CASE WHEN OLD.title IS DISTINCT FROM NEW.title THEN jsonb_build_object('old', OLD.title, 'new', NEW.title) ELSE NULL END,
                    'description', CASE WHEN OLD.description IS DISTINCT FROM NEW.description THEN jsonb_build_object('old', OLD.description, 'new', NEW.description) ELSE NULL END
                )
            ),
            NEW.id
        );
    END IF;
    RETURN NEW;
END;
$function$
;

grant delete on table "public"."columns" to "anon";

grant insert on table "public"."columns" to "anon";

grant references on table "public"."columns" to "anon";

grant select on table "public"."columns" to "anon";

grant trigger on table "public"."columns" to "anon";

grant truncate on table "public"."columns" to "anon";

grant update on table "public"."columns" to "anon";

grant delete on table "public"."columns" to "authenticated";

grant insert on table "public"."columns" to "authenticated";

grant references on table "public"."columns" to "authenticated";

grant select on table "public"."columns" to "authenticated";

grant trigger on table "public"."columns" to "authenticated";

grant truncate on table "public"."columns" to "authenticated";

grant update on table "public"."columns" to "authenticated";

grant delete on table "public"."columns" to "service_role";

grant insert on table "public"."columns" to "service_role";

grant references on table "public"."columns" to "service_role";

grant select on table "public"."columns" to "service_role";

grant trigger on table "public"."columns" to "service_role";

grant truncate on table "public"."columns" to "service_role";

grant update on table "public"."columns" to "service_role";

grant delete on table "public"."comments" to "anon";

grant insert on table "public"."comments" to "anon";

grant references on table "public"."comments" to "anon";

grant select on table "public"."comments" to "anon";

grant trigger on table "public"."comments" to "anon";

grant truncate on table "public"."comments" to "anon";

grant update on table "public"."comments" to "anon";

grant delete on table "public"."comments" to "authenticated";

grant insert on table "public"."comments" to "authenticated";

grant references on table "public"."comments" to "authenticated";

grant select on table "public"."comments" to "authenticated";

grant trigger on table "public"."comments" to "authenticated";

grant truncate on table "public"."comments" to "authenticated";

grant update on table "public"."comments" to "authenticated";

grant delete on table "public"."comments" to "service_role";

grant insert on table "public"."comments" to "service_role";

grant references on table "public"."comments" to "service_role";

grant select on table "public"."comments" to "service_role";

grant trigger on table "public"."comments" to "service_role";

grant truncate on table "public"."comments" to "service_role";

grant update on table "public"."comments" to "service_role";

grant delete on table "public"."organization_members" to "anon";

grant insert on table "public"."organization_members" to "anon";

grant references on table "public"."organization_members" to "anon";

grant select on table "public"."organization_members" to "anon";

grant trigger on table "public"."organization_members" to "anon";

grant truncate on table "public"."organization_members" to "anon";

grant update on table "public"."organization_members" to "anon";

grant delete on table "public"."organization_members" to "authenticated";

grant insert on table "public"."organization_members" to "authenticated";

grant references on table "public"."organization_members" to "authenticated";

grant select on table "public"."organization_members" to "authenticated";

grant trigger on table "public"."organization_members" to "authenticated";

grant truncate on table "public"."organization_members" to "authenticated";

grant update on table "public"."organization_members" to "authenticated";

grant delete on table "public"."organization_members" to "service_role";

grant insert on table "public"."organization_members" to "service_role";

grant references on table "public"."organization_members" to "service_role";

grant select on table "public"."organization_members" to "service_role";

grant trigger on table "public"."organization_members" to "service_role";

grant truncate on table "public"."organization_members" to "service_role";

grant update on table "public"."organization_members" to "service_role";

grant delete on table "public"."organizations" to "anon";

grant insert on table "public"."organizations" to "anon";

grant references on table "public"."organizations" to "anon";

grant select on table "public"."organizations" to "anon";

grant trigger on table "public"."organizations" to "anon";

grant truncate on table "public"."organizations" to "anon";

grant update on table "public"."organizations" to "anon";

grant delete on table "public"."organizations" to "authenticated";

grant insert on table "public"."organizations" to "authenticated";

grant references on table "public"."organizations" to "authenticated";

grant select on table "public"."organizations" to "authenticated";

grant trigger on table "public"."organizations" to "authenticated";

grant truncate on table "public"."organizations" to "authenticated";

grant update on table "public"."organizations" to "authenticated";

grant delete on table "public"."organizations" to "service_role";

grant insert on table "public"."organizations" to "service_role";

grant references on table "public"."organizations" to "service_role";

grant select on table "public"."organizations" to "service_role";

grant trigger on table "public"."organizations" to "service_role";

grant truncate on table "public"."organizations" to "service_role";

grant update on table "public"."organizations" to "service_role";

grant delete on table "public"."project_members" to "anon";

grant insert on table "public"."project_members" to "anon";

grant references on table "public"."project_members" to "anon";

grant select on table "public"."project_members" to "anon";

grant trigger on table "public"."project_members" to "anon";

grant truncate on table "public"."project_members" to "anon";

grant update on table "public"."project_members" to "anon";

grant delete on table "public"."project_members" to "authenticated";

grant insert on table "public"."project_members" to "authenticated";

grant references on table "public"."project_members" to "authenticated";

grant select on table "public"."project_members" to "authenticated";

grant trigger on table "public"."project_members" to "authenticated";

grant truncate on table "public"."project_members" to "authenticated";

grant update on table "public"."project_members" to "authenticated";

grant delete on table "public"."project_members" to "service_role";

grant insert on table "public"."project_members" to "service_role";

grant references on table "public"."project_members" to "service_role";

grant select on table "public"."project_members" to "service_role";

grant trigger on table "public"."project_members" to "service_role";

grant truncate on table "public"."project_members" to "service_role";

grant update on table "public"."project_members" to "service_role";

grant delete on table "public"."projects" to "anon";

grant insert on table "public"."projects" to "anon";

grant references on table "public"."projects" to "anon";

grant select on table "public"."projects" to "anon";

grant trigger on table "public"."projects" to "anon";

grant truncate on table "public"."projects" to "anon";

grant update on table "public"."projects" to "anon";

grant delete on table "public"."projects" to "authenticated";

grant insert on table "public"."projects" to "authenticated";

grant references on table "public"."projects" to "authenticated";

grant select on table "public"."projects" to "authenticated";

grant trigger on table "public"."projects" to "authenticated";

grant truncate on table "public"."projects" to "authenticated";

grant update on table "public"."projects" to "authenticated";

grant delete on table "public"."projects" to "service_role";

grant insert on table "public"."projects" to "service_role";

grant references on table "public"."projects" to "service_role";

grant select on table "public"."projects" to "service_role";

grant trigger on table "public"."projects" to "service_role";

grant truncate on table "public"."projects" to "service_role";

grant update on table "public"."projects" to "service_role";

grant delete on table "public"."tags" to "anon";

grant insert on table "public"."tags" to "anon";

grant references on table "public"."tags" to "anon";

grant select on table "public"."tags" to "anon";

grant trigger on table "public"."tags" to "anon";

grant truncate on table "public"."tags" to "anon";

grant update on table "public"."tags" to "anon";

grant delete on table "public"."tags" to "authenticated";

grant insert on table "public"."tags" to "authenticated";

grant references on table "public"."tags" to "authenticated";

grant select on table "public"."tags" to "authenticated";

grant trigger on table "public"."tags" to "authenticated";

grant truncate on table "public"."tags" to "authenticated";

grant update on table "public"."tags" to "authenticated";

grant delete on table "public"."tags" to "service_role";

grant insert on table "public"."tags" to "service_role";

grant references on table "public"."tags" to "service_role";

grant select on table "public"."tags" to "service_role";

grant trigger on table "public"."tags" to "service_role";

grant truncate on table "public"."tags" to "service_role";

grant update on table "public"."tags" to "service_role";

grant delete on table "public"."task_logs" to "anon";

grant insert on table "public"."task_logs" to "anon";

grant references on table "public"."task_logs" to "anon";

grant select on table "public"."task_logs" to "anon";

grant trigger on table "public"."task_logs" to "anon";

grant truncate on table "public"."task_logs" to "anon";

grant update on table "public"."task_logs" to "anon";

grant delete on table "public"."task_logs" to "authenticated";

grant insert on table "public"."task_logs" to "authenticated";

grant references on table "public"."task_logs" to "authenticated";

grant select on table "public"."task_logs" to "authenticated";

grant trigger on table "public"."task_logs" to "authenticated";

grant truncate on table "public"."task_logs" to "authenticated";

grant update on table "public"."task_logs" to "authenticated";

grant delete on table "public"."task_logs" to "service_role";

grant insert on table "public"."task_logs" to "service_role";

grant references on table "public"."task_logs" to "service_role";

grant select on table "public"."task_logs" to "service_role";

grant trigger on table "public"."task_logs" to "service_role";

grant truncate on table "public"."task_logs" to "service_role";

grant update on table "public"."task_logs" to "service_role";

grant delete on table "public"."task_tags" to "anon";

grant insert on table "public"."task_tags" to "anon";

grant references on table "public"."task_tags" to "anon";

grant select on table "public"."task_tags" to "anon";

grant trigger on table "public"."task_tags" to "anon";

grant truncate on table "public"."task_tags" to "anon";

grant update on table "public"."task_tags" to "anon";

grant delete on table "public"."task_tags" to "authenticated";

grant insert on table "public"."task_tags" to "authenticated";

grant references on table "public"."task_tags" to "authenticated";

grant select on table "public"."task_tags" to "authenticated";

grant trigger on table "public"."task_tags" to "authenticated";

grant truncate on table "public"."task_tags" to "authenticated";

grant update on table "public"."task_tags" to "authenticated";

grant delete on table "public"."task_tags" to "service_role";

grant insert on table "public"."task_tags" to "service_role";

grant references on table "public"."task_tags" to "service_role";

grant select on table "public"."task_tags" to "service_role";

grant trigger on table "public"."task_tags" to "service_role";

grant truncate on table "public"."task_tags" to "service_role";

grant update on table "public"."task_tags" to "service_role";

grant delete on table "public"."tasks" to "anon";

grant insert on table "public"."tasks" to "anon";

grant references on table "public"."tasks" to "anon";

grant select on table "public"."tasks" to "anon";

grant trigger on table "public"."tasks" to "anon";

grant truncate on table "public"."tasks" to "anon";

grant update on table "public"."tasks" to "anon";

grant delete on table "public"."tasks" to "authenticated";

grant insert on table "public"."tasks" to "authenticated";

grant references on table "public"."tasks" to "authenticated";

grant select on table "public"."tasks" to "authenticated";

grant trigger on table "public"."tasks" to "authenticated";

grant truncate on table "public"."tasks" to "authenticated";

grant update on table "public"."tasks" to "authenticated";

grant delete on table "public"."tasks" to "service_role";

grant insert on table "public"."tasks" to "service_role";

grant references on table "public"."tasks" to "service_role";

grant select on table "public"."tasks" to "service_role";

grant trigger on table "public"."tasks" to "service_role";

grant truncate on table "public"."tasks" to "service_role";

grant update on table "public"."tasks" to "service_role";

grant delete on table "public"."users" to "anon";

grant insert on table "public"."users" to "anon";

grant references on table "public"."users" to "anon";

grant select on table "public"."users" to "anon";

grant trigger on table "public"."users" to "anon";

grant truncate on table "public"."users" to "anon";

grant update on table "public"."users" to "anon";

grant delete on table "public"."users" to "authenticated";

grant insert on table "public"."users" to "authenticated";

grant references on table "public"."users" to "authenticated";

grant select on table "public"."users" to "authenticated";

grant trigger on table "public"."users" to "authenticated";

grant truncate on table "public"."users" to "authenticated";

grant update on table "public"."users" to "authenticated";

grant delete on table "public"."users" to "service_role";

grant insert on table "public"."users" to "service_role";

grant references on table "public"."users" to "service_role";

grant select on table "public"."users" to "service_role";

grant trigger on table "public"."users" to "service_role";

grant truncate on table "public"."users" to "service_role";

grant update on table "public"."users" to "service_role";

create policy "Allow access to columns in accessible projects"
on "public"."columns"
as permissive
for select
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = columns.project_id) AND (project_members.user_id = auth.uid())))));


create policy "Allow delete from columns in accessible projects"
on "public"."columns"
as permissive
for delete
to authenticated
using ((( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = columns.project_id))));


create policy "Allow insert to columns in accessible projects"
on "public"."columns"
as permissive
for insert
to authenticated
with check ((( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = columns.project_id))));


create policy "Allow update to columns in accessible projects"
on "public"."columns"
as permissive
for update
to authenticated
using ((( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = columns.project_id))))
with check ((( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = columns.project_id))));


create policy "Allow access to comments in accessible tasks"
on "public"."comments"
as permissive
for select
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = comments.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


create policy "Allow delete from comments in accessible tasks"
on "public"."comments"
as permissive
for delete
to authenticated
using ((user_id = auth.uid()));


create policy "Allow insert to comments in accessible tasks"
on "public"."comments"
as permissive
for insert
to authenticated
with check ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = comments.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


create policy "Allow update to comments in accessible tasks"
on "public"."comments"
as permissive
for update
to authenticated
using ((user_id = auth.uid()))
with check ((user_id = auth.uid()));


create policy "Authenticated users can delete organizations they own"
on "public"."organizations"
as permissive
for delete
to authenticated
using ((( SELECT auth.uid() AS uid) = owner_id));


create policy "Authenticated users can insert organizations"
on "public"."organizations"
as permissive
for insert
to authenticated
with check ((( SELECT auth.uid() AS uid) = owner_id));


create policy "Authenticated users can update organizations they own or are me"
on "public"."organizations"
as permissive
for update
to authenticated
using (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT organization_members.user_id
   FROM organization_members
  WHERE (organization_members.org_id = organizations.id)))))
with check (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT organization_members.user_id
   FROM organization_members
  WHERE (organization_members.org_id = organizations.id)))));


create policy "Authenticated users can view organizations they own or are memb"
on "public"."organizations"
as permissive
for select
to authenticated
using (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT organization_members.user_id
   FROM organization_members
  WHERE (organization_members.org_id = organizations.id)))));


create policy "Allow delete to project members"
on "public"."project_members"
as permissive
for delete
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members pm
  WHERE ((pm.project_id = project_members.project_id) AND (pm.user_id = auth.uid())))));


create policy "Allow insert to project members"
on "public"."project_members"
as permissive
for insert
to authenticated
with check ((EXISTS ( SELECT 1
   FROM project_members pm
  WHERE ((pm.project_id = project_members.project_id) AND (pm.user_id = auth.uid())))));


create policy "Allow read to organization members"
on "public"."project_members"
as permissive
for select
to authenticated
using ((EXISTS ( SELECT 1
   FROM organization_members
  WHERE (organization_members.user_id = auth.uid()))));


create policy "Allow update to project members"
on "public"."project_members"
as permissive
for update
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members pm
  WHERE ((pm.project_id = project_members.project_id) AND (pm.user_id = auth.uid())))))
with check ((EXISTS ( SELECT 1
   FROM project_members pm
  WHERE ((pm.project_id = project_members.project_id) AND (pm.user_id = auth.uid())))));


create policy "Authenticated users can delete projects they own"
on "public"."projects"
as permissive
for delete
to authenticated
using ((( SELECT auth.uid() AS uid) = owner_id));


create policy "Authenticated users can insert projects"
on "public"."projects"
as permissive
for insert
to authenticated
with check ((( SELECT auth.uid() AS uid) = owner_id));


create policy "Authenticated users can update projects they own or are members"
on "public"."projects"
as permissive
for update
to authenticated
using (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = projects.id)))))
with check (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = projects.id)))));


create policy "Authenticated users can view projects they own or are members o"
on "public"."projects"
as permissive
for select
to authenticated
using (((( SELECT auth.uid() AS uid) = owner_id) OR (( SELECT auth.uid() AS uid) IN ( SELECT project_members.user_id
   FROM project_members
  WHERE (project_members.project_id = projects.id)))));


create policy "Allow access to tasks in accessible projects"
on "public"."tasks"
as permissive
for select
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = tasks.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


create policy "Allow delete from tasks in accessible projects"
on "public"."tasks"
as permissive
for delete
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = tasks.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


create policy "Allow insert to tasks in accessible projects"
on "public"."tasks"
as permissive
for insert
to authenticated
with check ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = tasks.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


create policy "Allow update to tasks in accessible projects"
on "public"."tasks"
as permissive
for update
to authenticated
using ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = tasks.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))))
with check ((EXISTS ( SELECT 1
   FROM project_members
  WHERE ((project_members.project_id = tasks.project_id) AND (project_members.user_id = ( SELECT auth.uid() AS uid))))));


CREATE TRIGGER project_members_trigger AFTER INSERT ON public.project_members FOR EACH ROW EXECUTE FUNCTION add_organization_member();

CREATE TRIGGER add_project_member AFTER INSERT ON public.projects FOR EACH ROW EXECUTE FUNCTION handle_new_project();

CREATE TRIGGER trigger_delete_task_tags_on_tag AFTER DELETE ON public.tags FOR EACH ROW EXECUTE FUNCTION delete_task_tags_relation();

CREATE TRIGGER after_significant_task_update AFTER UPDATE ON public.tasks FOR EACH ROW EXECUTE FUNCTION log_significant_task_update();

CREATE TRIGGER trigger_delete_task_tags_on_task AFTER DELETE ON public.tasks FOR EACH ROW EXECUTE FUNCTION delete_task_tags_relation();
```